jQuery(function(a){a(".bitcommerce-ordering").on("change","select.orderby",function(){a(this).closest("form").submit()}),a("div.quantity:not(.buttons_added), td.quantity:not(.buttons_added)").addClass("buttons_added").append('<input type="button" value="+" class="plus" />').prepend('<input type="button" value="-" class="minus" />').find(".input-text").attr("type","text"),a("input.qty:not(.product-quantity input.qty)").each(function(){var b=parseFloat(a(this).attr("min"));b&&b>0&&parseFloat(a(this).val())<b&&a(this).val(b)}),
	a(document).on("click",".plus, .minus",function()
	{
	var b=a(this).closest(".quantity").find(".qty,.num"),c=parseFloat(b.val()),d=parseFloat(b.attr("max")),e=parseFloat(b.attr("min")),f=b.attr("step");
	c&&""!=c&&"NaN"!=c||(c=0),(""==d||"NaN"==d)&&(d=""),(""==e||"NaN"==e)&&(e=0),("any"==f||""==f||void 0==f||"NaN"==parseFloat(f))&&(f=1),a(this).is(".plus")?b.val(d&&(d==c||c>d)?d:c+parseFloat(f)):e&&(e==c||e>c)?b.val(e):c>0&&b.val(c-parseFloat(f));
	if(a(this).closest(".product-addon").length>0){
		if(b.val() <= 0){b.val(0); b.trigger("change"); return;}
	}else{
		if(b.val() <= 0){b.val(1);return;}
	}
	b.trigger("change");


	})
});
jQuery(function($) {

	$(".num_and_button .qty").change(function(){
		var b = jQuery(this);
		var p = b.closest(".num_and_button");
		if(p.length>0){
			var href = p.find(".add_to_cart_btn").attr("href");
			if(href){
				if(href.indexOf("quantity")>-1){
					href = changeURLArg(href,'quantity',b.val());
				}else{
					href = href+"&quantity="+b.val();
				}
				p.find(".add_to_cart_btn").attr("data-quantity",b.val());
				p.find(".add_to_cart_btn").attr("href",href);
			}
		}

	});
	if($('.add_to_cart_button-ajax').length>0){
		$('.add_to_cart_button-ajax').unbind().bind('click', function() {
			// AJAX add to cart request
			var $thisbutton = $(this);

			if ( $thisbutton.is('.product_type_simple') ) {
				if (!$thisbutton.attr('data-product_id'))
					return true;

				$thisbutton.removeClass('added');
				$thisbutton.addClass('loading');
				var i18n_ajax_title = $thisbutton.attr("data-title");
				var i18n_ajax_closetime = $thisbutton.attr("data-close");
				var data = {
					action: 		'bitcommerce_add_to_cart',
					product_id: 	$thisbutton.attr('data-product_id'),
					quantity:       $thisbutton.attr('data-quantity')
				};

				// Trigger event
				$('body').trigger( 'adding_to_cart', [ $thisbutton, data ] );
				// Ajax action
				$.post( "/admin/admin-ajax.php", data, function( response ) {
					if ( ! response )
						return;
					if ( response.error && response.product_url ) {
						window.location = response.product_url;
						return;
					}
					$thisbutton.removeClass('loading');
					fragments = response.fragments;
					cart_hash = response.cart_hash;
					// Block fragments class
					if ( fragments ) {
						$.each(fragments, function(key, value) {
							$(key).addClass('updating');
						});
					}

					// Changes button classes
					$thisbutton.addClass('added');

					refresh_all_cart_panel(response.htm);

					qfy_popinfo_fun('<div style="text-align:center;" ><img class="qfy_pop_checkedimg" src="/FeiEditor/images/bitcms/check.png" style="margin-top:20px;margin-bottom:20px;" /><div style="padding-bottom:20px;">'+i18n_ajax_title+'</div></div>',i18n_ajax_closetime>1?i18n_ajax_closetime:1)

					// Replace fragments
					if ( fragments ) {
						$.each(fragments, function(key, value) {
							$(key).replaceWith(value);
						});
					}
					// Trigger event so themes can refresh other areas
					$('body').trigger( 'added_to_cart', [ fragments, cart_hash ] );

				});
				return false;
			}
			return true;
		});
	}



	$(".product-favorities").click(function(){
		if($(this).hasClass("featured")){
			var data = {action:"set_favorites",type:"deleteFavoriteGoods","product_id":$(this).attr("data-id")};
		}else{
			var data = {action:"set_favorites",type:"addFavoriteGoods","product_id":$(this).attr("data-id")};
		}
		jQuery.post("/admin/admin-ajax.php", data, function( response ) {
			var rlt = $.parseJSON(response);
			if(rlt.url){
				location.href=rlt.url;
			}else if(rlt.data=="success"){
				location.reload();
			}
		});
	})
	// Ajax add to cart
	if (typeof wc_add_to_cart_params !== "undefined"){

			$('.productlists.add_to_cart_button').unbind().bind('click', function() {
				// AJAX add to cart request
				var $thisbutton = $(this);

				if ( $thisbutton.is('.product_type_simple') ) {
					if (!$thisbutton.attr('data-product_id'))
						return true;

					$thisbutton.removeClass('added');
					$thisbutton.addClass('loading');

					var data = {
						action: 		'bitcommerce_add_to_cart',
						product_id: 	$thisbutton.attr('data-product_id'),
						quantity:       $thisbutton.attr('data-quantity')
					};

					// Trigger event
					$('body').trigger( 'adding_to_cart', [ $thisbutton, data ] );
					// Ajax action
					$.post( "/admin/admin-ajax.php", data, function( response ) {
						if ( ! response )
							return;
						if ( response.error && response.product_url ) {
							window.location = response.product_url;
							return;
						}
						$thisbutton.removeClass('loading');
						fragments = response.fragments;
						cart_hash = response.cart_hash;
						// Block fragments class
						if ( fragments ) {
							$.each(fragments, function(key, value) {
								$(key).addClass('updating');
							});
						}

						// Changes button classes
						$thisbutton.addClass('added');

						refresh_all_cart_panel(response.htm);

						qfy_popinfo_fun('<div style="text-align:center;" ><img class="qfy_pop_checkedimg" src="/FeiEditor/images/bitcms/check.png" style="margin-top:20px;margin-bottom:20px;" /><div style="padding-bottom:20px;">'+wc_add_to_cart_params.i18n_ajax_title+'</div></div>',wc_add_to_cart_params.i18n_ajax_closetime>1?wc_add_to_cart_params.i18n_ajax_closetime:1)

						// Replace fragments
						if ( fragments ) {
							$.each(fragments, function(key, value) {
								$(key).replaceWith(value);
							});
						}
						// Trigger event so themes can refresh other areas
						$('body').trigger( 'added_to_cart', [ fragments, cart_hash ] );

					});
					return false;
				}
				return true;
			});
	}
});

//custom
function shopping_cart_fun(){
	var menuTimeoutShow,
	menuTimeoutHide;
	var $ = jQuery;
	jQuery(".shopping-cart.e_mouse").on("mouseenter tap", function(e) {
		if(e.type == "tap") e.stopPropagation();

		var $this = $(this);
		$this.addClass("dt-hovered");
		if (jQuery("#page").width() - ($this.children('.shopping-cart-inner').offset().left - jQuery("#page").offset().left) - 230 < 0) {
			$this.children('.shopping-cart-inner').addClass("right-overflow");
		}

		clearTimeout(menuTimeoutShow);
		clearTimeout(menuTimeoutHide);

		menuTimeoutShow = setTimeout(function() {
			if($this.hasClass("dt-hovered")){
					$this.children('.shopping-cart-inner').stop().css("visibility", "visible").animate({
						"opacity": 1
					}, 200);
			}
		}, 350);
	});

	jQuery(".shopping-cart.e_mouse").on("mouseleave", function(e) {
		var $this = $(this);
		$this.removeClass("dt-hovered");

		clearTimeout(menuTimeoutShow);
		clearTimeout(menuTimeoutHide);

		menuTimeoutHide = setTimeout(function() {
			if(!$this.hasClass("dt-hovered")){

					$this.children('.shopping-cart-inner').stop().animate({
						"opacity": 0
					}, 150, function() {
						jQuery(this).css("visibility", "hidden");
					});
					setTimeout(function() {
						if(!$this.hasClass("dt-hovered")){
							$this.children('.shopping-cart-inner').removeClass("right-overflow");
						}
					}, 400);



			}
		}, 200);

	});


	jQuery(".shopping-cart.e_click .wc-ico-cart").on("click", function(e) {
		var body_w = jQuery("body").width();
		if(body_w>992){
			e.stopPropagation();
			if(jQuery("body >.shopping-cart").length>0){
				var $this = jQuery("body >.shopping-cart");
			}else{
				jQuery("body").append( '<div class="shopping-cart bitcommerce e_click" id="shopping-cart-bitcommerce" style="position:relative;">'+jQuery(this).closest(".shopping-cart").html()+'</div>');
				$this = jQuery("body >.shopping-cart");
			}
			$this.addClass("dt-hovered");
			clearTimeout(menuTimeoutShow);
			clearTimeout(menuTimeoutHide);

			menuTimeoutHide = setTimeout(function() {
				if($this.hasClass("dt-hovered")){
					$this.children('.shopping-cart-inner').stop().addClass("qfyanimated").css({"opacity":"1","visibility":"visible","animation-duration":"0.25s","animation-delay":"0s","animation-name":"qfyfadeInLeft"});
				}
			}, 350);
			 jQuery(".shopping-cart-film").unbind().click(function(){
				 if(jQuery('.shopping-cart.e_click').css("opacity")!="0"){
					    jQuery('.shopping-cart.e_click').removeClass("dt-hovered");
						jQuery('.shopping-cart.e_click .shopping-cart-inner').stop().css({"animation-name":"qfyfadeInToRight"}).animate({
							"opacity": 0
						}, 250, function() {
							jQuery(this).css("visibility", "hidden");
						});
				 }
	       })
			return false;
		}
	});



}
function setting_cart_inner(e,obj){
	e.stopPropagation();

	parent.vc.vc_edit_productcolor_dialog.render("",".shopping_cart_inner");
	if(jQuery(obj).closest("#shopping-cart-bitcommerce").hasClass("e_mouse")){
		parent.jQuery(".shopping_cart_inner.designtable").addClass("mouseclass");
	}else{
		parent.jQuery(".shopping_cart_inner.designtable").removeClass("mouseclass");
	}
}
var is_car_submiting =false;
function cart_submit(obj,e){
	if ( 'function' === typeof gtag_report_conversion ) {
		gtag_report_conversion();
	}
	var form = jQuery(obj).closest("form");
	var isajax = form.attr("data-ajax");
	if(isajax>0){

		   e.stopPropagation();
		   if(is_car_submiting){
				return;
			}else{
				is_car_submiting = true;
			}

		   var text1 = form.attr("data-text1")?form.attr("data-text1"):"添加成功！";
		   var text2 = form.attr("data-text2")?form.attr("data-text2"):"去購物車結算";
		   var text3 = form.attr("data-text3")?form.attr("data-text3"):"成功加入購物車";
		   var url =  form.attr("data-carurl");

			jQuery(obj).closest("form").ajaxSubmit({
				dataType: 'json',
				error: function(xhr, status, err) {
					is_car_submiting = false;
				},
				success:function(obj){
					jQuery(".ocr_outer input,.ocr_outer textarea").val("");
					is_car_submiting = false;

					if(obj.status=="success"){
						if(obj.redirct_uri){
							location.href = obj.redirct_uri;
							return;
						}
						var htm = obj.msg;
						if(isajax==2){
							qfy_popinfo_fun('<div style="text-align:center;" ><img class="qfy_pop_checkedimg" src="/FeiEditor/images/bitcms/check.png" style="margin-top:20px;margin-bottom:20px;" /><div style="padding-bottom:20px;line-height:30px;">'+text3+'</div></div>',3);

						}else if(isajax==3){
							var body_w = jQuery("body").width();
							if(body_w<=992){
								if(typeof global_product_add_cart!="undefined"){
									qfy_popinfo_fun('<div class="add_cart_notice" >'+global_product_add_cart+'</div>',3);
								}else {
									qfy_popinfo_fun('<div style="text-align:center;" ><img class="qfy_pop_checkedimg" src="/FeiEditor/images/bitcms/check.png" style="margin-top:20px;margin-bottom:20px;" /><div style="padding-bottom:20px;line-height:30px;">' + text3 + '</div></div>', 3)
								}
							}else{
								jQuery("body >.shopping-cart").remove();
						    	jQuery("body").append(htm);
						    	if(jQuery("body").hasClass("compose-mode") && jQuery("body >.shopping-cart .setting_cart_inner").length==0){
						    		jQuery("body >.shopping-cart .shopping-cart-inner").append('<div class="controls-element vc-controls bit-controls-element inner" style="line-height: 0px;display:block;"><div class="controls-cc" style="left:50%;top:50%;"><a class="control-btn vc-element-name"><span class="vc-btn-content vo-btn-nomove">设置</span></a><a title="设置" class="control-btn control-btn-edit  " onclick="setting_cart_inner(event,this);"><span class="vc-btn-content"><span class="icon"></span></span></a></div></div>');
								}
						    	jQuery("body >.shopping-cart").removeClass("e_mouse").addClass("e_click").addClass("dt-hovered");
						    	jQuery('body >.shopping-cart .shopping-cart-inner').addClass("rightfix qfyanimated").css({"opacity":"1","visibility":"visible","animation-duration":"0.25s","animation-delay":"0s","animation-name":"qfyfadeInLeft"});

								 jQuery(".shopping-cart-film").unbind().click(function(){
									 if(jQuery('.shopping-cart.e_click').css("opacity")!="0"){
										    jQuery('.shopping-cart.e_click').removeClass("dt-hovered");
											jQuery('.shopping-cart.e_click .shopping-cart-inner').stop().css({"animation-name":"qfyfadeInToRight"}).animate({
												"opacity": 0
											}, 250, function() {
												jQuery(this).css("visibility", "hidden");
											});
									 }
							   })
							}
						}else{
							var tablewidth = jQuery(".cart_button_table").width();
							var bgcolor =  jQuery(".cart_button_table .single_add_to_cart_button").css("background-color");
							var color  =  jQuery(".cart_button_table .single_add_to_cart_button").css("color");
							jQuery(".cart_btton_popinfo").remove();
							var body_w = jQuery("body").width();
							var trtop ="animation-name: qfyfadeInUp;"
							if(body_w<=992){
								trtop = "top:-90px;animation-name: qfyfadeInDown;";
							}
							var  tr = "<tr class='cart_btton_popinfo  qfyanimated' style='position:absolute;opacity:0;"+trtop+";animation-duration: 1s; animation-delay: 0s; '><td colspan=2 style='padding:0;'><div style='width:"+(tablewidth)+"px;min-width:200px;padding:20px 5px 20px 20px;border:2px solid #ddd;background: #fff;margin-top:10px;text-align:left;'> <span style='color:#555555;font-weight:700;font-size:12px;'>"+text1+"</span>&nbsp;&nbsp;<a href='"+url+"'><button type='button' style='background-color:"+bgcolor+";border:1px solid "+bgcolor+";color:"+color+";padding:4px 9px;font-size:12px;'>"+text2+"</button></a>&nbsp;&nbsp;<span style='cursor:pointer;position:absolute;right: 6px;top: 12px;color: #666;font-size:12px;' class='close_cart'>✕</span></div></td></tr>";
							if(body_w>992){
								jQuery(".cart_button_table").append(tr);
							}else{
								jQuery(".cart_button_table").prepend(tr);
							}
							jQuery(".cart_btton_popinfo").animate({opacity:"1"});
							jQuery(".cart_button_table .cart_btton_popinfo .close_cart").click(function(){
								jQuery(".cart_btton_popinfo").remove();
							})


						}
						refresh_all_cart_panel(htm);
					}else if(obj.status=="error"){
						qfy_popinfo_fun('<div style="text-align:center;" ><div class="cart_error" style="padding:20px;line-height:30px;">'+obj.msg+'</div></div>',10);
					}else{
						//未知异常
					}

				}
			});
			return false;
	}else{
		form.submit();
	}
}
var input_delay_timeout = false;
var is_cart_updating = false;

function cart_update(obj,e,delay){
	if(delay =="nodelay"){
		if(input_delay_timeout) clearTimeout(input_delay_timeout);
		_cart_update(obj,e);
	}else if(delay =="quick"){
		if(input_delay_timeout) clearTimeout(input_delay_timeout);
		input_delay_timeout = setTimeout(function() {
			_cart_update(obj,e);
		}, 300);
	}else{
		if(input_delay_timeout) clearTimeout(input_delay_timeout);
		input_delay_timeout = setTimeout(function() {
			_cart_update(obj,e);
		}, 1200);
	}
}

function _cart_update(obj,e){
	var p =  jQuery(".qfy_cart.qfy_wc_div");

	var form =  p.find("form:visible");

	var sidebar =form.find(".cart-collaterals");
	sidebar.block({message: null, overlayCSS: {background: '#fff url(//f.goodq.top/qfy-content/plugins/bitcommerce/assets/images/ajax-loader@2x.gif) no-repeat center', backgroundSize: '16px 16px', opacity: 0.6}});

	var atts = form.closest(".qfy-element").find(".qfy-wcnotice").attr("data-atts");
	var data = {'update_cart': "update_cart","cart_atts":atts};
	if( jQuery(obj).hasClass("apply_coupons_credits")){
		var coupon_code =jQuery(obj).find('div.code').text();
		data = {'update_cart': "update_cart","sc-page":"cart","apply_coupon":"yes","coupon_code":coupon_code,"cart_atts":atts};
	}else if( jQuery(obj).hasClass("bitcommerce-remove-coupon")){
		var coupon_code = jQuery(obj).attr("data-couponcode");
		data = {'update_cart': "update_cart","sc-page":"cart","remove_coupon":coupon_code,"cart_atts":atts};
	}else if( jQuery(obj).hasClass("remove")){
		var key = jQuery(obj).attr("data-key");
		data = {'update_cart': "update_cart","sc-page":"cart","remove_item":key,"cart_atts":atts};
	}else if( jQuery(obj).attr("name")=="apply_coupon"){
		var coupon_code = jQuery(obj).prev("input").val();
		data = {'update_cart': "update_cart","sc-page":"cart","apply_coupon":"yes","coupon_code":coupon_code,"cart_atts":atts};
	}else if( jQuery(obj).attr("name")=="bit_purse"){
		var discount_amount = jQuery(obj).prev("input").val();
		data = {'update_cart': "update_cart","sc-page":"cart","bit_purse":"yes","discount_amount":discount_amount,"cart_atts":atts};
	}

	is_cart_updating = true;
	form.ajaxSubmit({
		data:data,
		success:function(response){
			is_cart_updating = false;
			 var obj=jQuery.parseJSON(response);
			 jQuery(".subtotal-amount").html(obj.sum);
			 jQuery(".wc-ico-cart .carsize,.mobile-cart-amount ").html(obj.num);
			 if(obj.num==0){
				 jQuery(".wc-ico-cart").addClass("empty");
				 jQuery(".wc-ico-cart .carsize").html("");
			 }
			 refresh_all_cart_panel(obj.htm,obj.carthtm);
		},
		error: function(e) {
			is_cart_updating = false;
		}
	});
}

function minicart_remove(thisobj,e,remove_item,_qfnonce){
	 e.stopPropagation();
	 var li = jQuery(thisobj).closest(".cart-product-item");
	 var itemkey =  li.attr("data-itemkey");
	 jQuery(".cart-product-item[data-itemkey='"+itemkey+"']").animate({opacity:"0"},'fast',function(){
			jQuery(this).remove();
		});

	jQuery.post("/admin/admin-ajax.php",{action:"bitcommerce_remove_from_cart",remove_item:remove_item,_qfnonce:_qfnonce}, function( response ) {
		var obj=jQuery.parseJSON(response);
		if(obj.status=="success"){
			 jQuery(".subtotal-amount").html(obj.sum);
			 jQuery(".wc-ico-cart .carsize,.mobile-cart-amount ").html(obj.num);
			 if(obj.num==0){
				 refresh_all_cart_panel(obj.htm,obj.carthtm);
				 jQuery(".wc-ico-cart").addClass("empty");
				 jQuery(".wc-ico-cart .carsize").html("");
			 }
		 }
	});
	return false;
}
var wait_cart_update_timeout = false;
function wait_cart_update(obj,e){
	if(is_cart_updating==false){
		cart_update(obj,e,'quick');
	}else{
		if(wait_cart_update_timeout) clearTimeout(wait_cart_update_timeout);
		wait_cart_update_timeout = setTimeout(function(){
			wait_cart_update(obj,e);
		},300);
	}
}
function qfy_cart_panel_event(){
	jQuery(".qfy_cart.qfy_wc_div input.plus").click(function(e){
		var obj = jQuery(this);
		wait_cart_update(obj,e);
	});

	jQuery(".qfy_cart.qfy_wc_div input.minus").click(function(e){
		var obj = jQuery(this);

		var qfy_input = obj.closest(".quantity").find(".qty,.num");
		var quantity = qfy_input.val();

		if(quantity <= 1){
			quantity = 1;
			qfy_input.val(1);
			return;
		}

		wait_cart_update(obj,e);
	});

	jQuery(".qfy_cart.qfy_wc_div .product-removelink .remove").click(function(e){
		 e.stopPropagation();
		var obj = jQuery(this);
		obj.closest(".cart_item").animate({opacity:"0"},'fast',function(){
			jQuery(this).hide();
		});
		cart_update(obj,e,'nodelay');
		return false;
	})
	jQuery(".qfy_checkout.qfy_wc_div .apply_coupons_credits").click(function(e){
		 e.stopPropagation();
		var v = jQuery(this).find(".code").text();
		 jQuery(this).closest("form").find("#coupon_code").val(v);
		 jQuery(this).closest("form").submit();
		return false;
	})
	jQuery(".qfy_cart.qfy_wc_div .apply_coupons_credits,.qfy_cart.qfy_wc_div [name='apply_coupon']").click(function(e){
		 e.stopPropagation();
		var obj = jQuery(this);
		cart_update(obj,e,'nodelay');
		return false;
	})
	jQuery(".qfy_cart.qfy_wc_div [name='bit_purse']").click(function(e){
		 e.stopPropagation();
		var obj = jQuery(this);
		cart_update(obj,e,'nodelay');
		return false;
	})

	jQuery(".qfy_cart.qfy_wc_div .bitcommerce-remove-coupon").click(function(e){
		 e.stopPropagation();
		var obj = jQuery(this);
		cart_update(obj,e,'nodelay');
		return false;
	})

	jQuery(".qfy_cart.qfy_wc_div .input-text.qty").keyup(function(e){
		var obj = jQuery(this);
		cart_update(obj,e,'delay');
	});

}
jQuery(function(){
	shopping_cart_fun();
	qfy_cart_panel_event();
})




function refresh_all_cart_panel(htm,carthtm){
	//topbar refresh,
	if(htm){
		jQuery("#top-bar .wf-td.right-block>#shopping-cart-bitcommerce").replaceWith(htm);
		if(jQuery(htm).find(".wc-ico-cart").length>0){
			if(jQuery(htm).find(".wc-ico-cart").attr("data-num")*1>0){
				jQuery(".dl-menu-fixedheader .wc-ico-cart,.qfy-cart-num").removeClass("empty");
				jQuery(".dl-menu-fixedheader .wc-ico-cart .carsize,.qfy-cart-num").html( jQuery(htm).find(".wc-ico-cart").attr("data-num")*1 );
			} else{
				jQuery(".dl-menu-fixedheader .wc-ico-cart,.qfy-cart-num").addClass("empty");
				jQuery(".dl-menu-fixedheader .wc-ico-cart .carsize,.qfy-cart-num").html("");
			}
		}

	}
	 if(carthtm && jQuery(".qfy_cart.qfy_wc_div").length>0){
		 jQuery(".qfy_cart.qfy_wc_div").html(jQuery(carthtm).html());
		 jQuery("div.quantity:not(.buttons_added), td.quantity:not(.buttons_added)").addClass('buttons_added').append('<input type="button" value="+" class="plus" />').prepend('<input type="button" value="-" class="minus" />').find(".input-text").attr("type","text");
		 qfy_cart_panel_event();
	 }

	//loginandregister refresh
	if(jQuery(".loginandregister.site_tooler").length>0){
		jQuery(".loginandregister.site_tooler").each(function(){
			if(!jQuery(this).is(":visible")){
				return;//仅更新显示的widget
			}

			var $this = jQuery(this);
			var wid = jQuery(this).attr("id");
			var novc = jQuery("body").hasClass("compose-mode")?"0":"1";
			jQuery.post("/admin/admin-ajax.php",{action:"bit_get_widgetview",wid:wid,novc:novc}, function(msg) {
				  $this.replaceWith(msg);
				  jQuery(".wf-mobile-visible.mobile-cart .mobile-cart-amount,.dl-menu-fixedheader .carsize").html(jQuery(msg).find(".carsize").html());

				  if(jQuery(msg).find(".carsize").html()*1>0){
					  jQuery(".dl-menu-fixedheader .wc-ico-cart").removeClass("empty");
				  } else{
					  jQuery(".dl-menu-fixedheader .wc-ico-cart").addClass("empty");
					  jQuery(".dl-menu-fixedheader .wc-ico-cart .carsize").html("");
				  }
				  jQuery("#shopping-cart-bitcommerce .carsize:not(.pulse1)").addClass("pulse1");
				  shopping_cart_fun();

				  jQuery(".dropdown-toggle").unbind("click").bind("click",function(){
						 var obj =jQuery(this).parent().find(".dropdown-menu");
						 if(obj.css("display") == "none"){
							obj.show();
						 }else{
							obj.hide();
						 }
				 })
			});
		})
	}
}
function beforeCartSubmit(obj){
	jQuery(obj).closest("form").find("input.quantity").val("0");
	jQuery(obj).closest(".group_li_quantity").find("input.quantity").val("1");
}
function video_product_play(obj,event){
	var postid = jQuery(obj).attr("data-postid");
	var videoid = jQuery(obj).attr("data-videoid");
	var media_id = jQuery(obj).attr("data-media_id");
	var source_id = jQuery(obj).attr("data-source_id");
	var se = jQuery(obj).attr("data-se");
	var nonce = jQuery(obj).attr("data-nonce");

	if(postid>0 && videoid>0){
		var url = "/api/video-server/play.php?se="+se+"&postid="+postid+"&videoid="+videoid;
	}else	if(media_id){
		var url = "/api/video-server/play.php?se="+se+"&media_id="+media_id;
	}else	if(source_id){
		var url = "/api/video-server/play.php?se="+se+"&source_id="+source_id;
	}
	var bodywidth = jQuery("body").width();
	var bodyheight = jQuery(window).height();
	if(bodywidth>800){
		top.jQuery.blockUI({css: {"top":"15%","left":"50%","margin-left":"-400px",width:"800px",height:"600px"},message: "<iframe allowfullscreen class='videoframe' style='width:100%;height:100%;display:block;border:0;overflow:hidden;' data-height='600' data-controlBarVisibility='hover' data-autoplay='true' src='"+url+"' ></iframe><div class='block-close' style='position:absolute;top:-26px;right:-3px;color:#fff;'>✕</div><div class='block-move ' title='按住拖动位置' style='position:absolute;top: 0;left: 0;color:#fff;cursor:move;background: transparent;width: 100%;height: 80px;'></div>"});
	}else{
		var h =  Math.round(bodywidth*3/4);
		var toppx = (bodyheight-h)/2;
		top.jQuery.blockUI({css: {"top":toppx+"px","left":"0",width:bodywidth+"px",height:h+"px"},message: "<iframe allowfullscreen class='videoframe'  style='width:100%;height:100%;display:block;border:0;overflow:hidden;' data-height='"+ h+"' data-controlBarVisibility='hover' data-autoplay='true' src='"+url+"' ></iframe><div class='block-close' style='position:absolute;top:-26px;right:7px;color:#fff;'>✕</div>"});
	}
	top.jQuery('.block-close').css('cursor', 'pointer').unbind().click(function(){
		 top.jQuery.unblockUI();
	});

	 if(typeof top.jQuery.fn.draggable=="undefined"){
		 top.jQuery.getScript("/qfy-includes/js/jquery/ui.all.min.js").done(function() {
			top.jQuery('.blockUI.blockMsg').unbind().draggable({handle: ".block-move"});
			top.jQuery('body,.blockOverlay').css('cursor', 'auto');
		 })
	 }else{
			top.jQuery('.blockUI.blockMsg').unbind().draggable({handle: ".block-move"});
			top.jQuery('body,.blockOverlay').css('cursor', 'auto');
	 }





}
function rehcharge_change(obj){
	var v = jQuery(obj).val();
	var p = jQuery(obj).closest(".qfyuser");
	if(v!="" && jQuery(obj).attr("name")=="product"){
		p.find("#amount").val("");
	}else if(jQuery(obj).attr("name")=="amount"){
		p.find("[name='product'].custom").click();
	}
}
function rehcharge(obj){
	var p = jQuery(obj).closest(".qfyuser");
	var v =p.find("[name='product']:checked").val();
	var quantity= 1;
	if(v!=""){
		product_id = v;
		quantity = 1;
	}else{
		product_id =p.find(".custom").attr("data-product-id");
		quantity = p.find("#amount").val();
		if(!quantity) quantity =1;
	}
	var data = {
			action: 		'bitcommerce_add_to_cart',
			tourl: 		'checkout',
			product_id: product_id,
			quantity:  quantity
	};

	p.find(".qfyuser-loading").show().addClass('inline');
	jQuery.post("/admin/admin-ajax.php", data, function( response ) {
		p.find(".qfyuser-loading").hide().removeClass('inline');
		if ( response.success && response.url ) {
			top.window.location.href = response.url;
			return;
		}else if(response.error && response.product_url){
			top.window.location.href = response.product_url;
			return;
		}
	},"json");
}
function get_one_coupon(obj){

	if(jQuery(obj).find(".saled:visible").length>0){
		 return;
	}
	if(jQuery(obj).hasClass("loading") ){
		return;
	}else{
		jQuery(obj).addClass("loading").append("<div class='loadingdiv' style='width:100%;height:100%;position:absolute;top:0;left:0;;background:url(//f.goodq.top/qfy-content/plugins/bitcommerce/assets/images/ajax-loader@2x.gif) no-repeat center rgba(255,255,255,0.2)'></div>");
	}
	var p = jQuery(obj).closest(".coupon-list");
	var v = jQuery(obj).attr("name");
	var data = {
			action: 		'bit_get_one_coupon',
			coupon_code: v,
	};
	jQuery.post("/admin/admin-ajax.php", data, function( response ) {
		jQuery(obj).removeClass("loading");
		jQuery(obj).find(".loadingdiv").remove();
		if(response=="success"){
			jQuery(obj).find(".saled").show();
		}else if(response=="login"){
			qfy_popinfo_fun('<div style="text-align:center;" ><div style="padding:20px;">'+(p.attr("data-failmsg1")?p.attr("data-failmsg1"):"优惠券领取失败，请登录!")+'</div></div>',3)
		}else{
			qfy_popinfo_fun('<div style="text-align:center;" ><div style="padding:20px;">'+(p.attr("data-failmsg2")?p.attr("data-failmsg2"):"优惠券领取失败")+'</div></div>',3)
		}
	});
}


function bc_change_web_address(obj){
	var $ = jQuery;
	var index = $(obj).val();
	$.post("/admin/admin-ajax.php",{action:"get_web_address","index":index},
		function(rlt) {
			rlt = $.parseJSON(rlt);
			if(rlt.status=="1"){
				var p = $(".qfy_wc_div #customer_details");

				var objs = rlt.data;
				$.each(objs,function(key,value){
					if(p.find("[name='"+key+"']").length>0){
						if(key=="shipping_state_new"){
							p.find("[name='"+key+"']").val(value).change();
						}else if(key=="shipping_city_new"){
							setTimeout(function(){
								console.log(key+" -  "+value);
								p.find("[name='"+key+"']").val(value).change();
							},50);
						}else if(key=="shipping_district_new"){
							setTimeout(function(){
								p.find("[name='"+key+"']").val(value);
							},100);
						}else {
							p.find("[name='"+key+"']").val(value);
						}
					}
					var replace_key = key.replace("shipping_","billing_");

					if(p.find("[name='"+replace_key+"']").length>0){
						if(replace_key=="billing_state_new"){
							p.find("[name='"+replace_key+"']").val(value).change();
						}else if(replace_key=="billing_city_new"){
							setTimeout(function(){
								p.find("[name='"+replace_key+"']").val(value).change();
							},50);
						}else if(replace_key=="billing_district_new"){
							setTimeout(function(){
								p.find("[name='"+replace_key+"']").val(value);
							},100);
						}else {
							p.find("[name='"+replace_key+"']").val(value);
						}
					}


				});

			}
		});
}


function bc_delete_web_address(obj,index){
	var $ = jQuery;
	$.post("/admin/admin-ajax.php",{action:"delete_web_address","index":index},
		function(rlt) {
			rlt = $.parseJSON(rlt);
			if(rlt.status=="1"){
				$(obj).closest(".item").remove();
				if($(".customer_addresses .item").length==0){
					p.find(".customer_details").show();
					p.find(".customer_details [name='index']").val(-1);
					p.find(".customer_addresses").hide();
				}
				bc_reset_select_address(rlt);
			}
		});

}
function address_change_init(objs){
	var $ = jQuery;
	var p = $(".qfy_wc_div #customer_details");

	$.each(objs,function(key,value){
		if(p.find("[name='"+key+"']").length>0){
			if(key=="shipping_state_new"){
				p.find("[name='"+key+"']").val(value).change();
			}else if(key=="shipping_city_new"){
				setTimeout(function(){
					p.find("[name='"+key+"']").val(value).change();
				},50);
			}else if(key=="shipping_district_new"){
				setTimeout(function(){
					p.find("[name='"+key+"']").val(value);
				},100);
			}else {
				p.find("[name='"+key+"']").val(value);
			}
		}
		var replace_key = key.replace("shipping_","billing_");

		if(p.find("[name='"+replace_key+"']").length>0){
			if(replace_key=="billing_state_new"){
				p.find("[name='"+replace_key+"']").val(value).change();
			}else if(replace_key=="billing_city_new"){
				setTimeout(function(){
					p.find("[name='"+replace_key+"']").val(value).change();
				},50);
			}else if(replace_key=="billing_district_new"){
				setTimeout(function(){
					p.find("[name='"+replace_key+"']").val(value);
				},100);
			}else {
				p.find("[name='"+replace_key+"']").val(value);
			}
		}


	});
}
function address_pop_html(id,e){
	e.preventDefault();
	e.stopPropagation();
	var $ = jQuery;

	if(jQuery("#"+id).length>0){
		notice_pre_event("#"+id+" .notice_warp","preview");
		pop_stopScroll();
	}

	if(id=="qfy_notice_address"){
		$(".yy_delete_address").unbind().bind("click",function(){
			var $this = $(this);
			var index = $this.attr("data-key");
			$.post("/admin/admin-ajax.php",{action:"delete_web_address","index":index},
				function(rlt) {
					rlt = $.parseJSON(rlt);
					if(rlt.status=="1"){
						$(".new-address-list [data-key='"+index+"'].address-item").remove();

					}
				});
		});


		$(".address-item .select-address").unbind().bind("click",function(){
			var $this = $(this).closest(".address-item");
			var index =  $this.find("[name='yy_address_default']").val();
			$.post("/admin/admin-ajax.php",{action:"update_web_address","index":index},
				function(rlt) {
					rlt = $.parseJSON(rlt);
					if(rlt.status=="1"){
						$("[name='mobile_address_id']").val(index);
						//刷新
						if(rlt.data){
							address_change_init(rlt.data[index]);
						}
						if(rlt.str){
							$(".new-table.address").html(rlt.str);
						}
						$("#QFY_close").click();
					}
				});

		});


		$("[name='yy_address_default']").unbind().bind("change",function(){
			var $this = $(this);
			var index = $this.val();
			$.post("/admin/admin-ajax.php",{action:"update_web_address","index":index},
				function(rlt) {
					rlt = $.parseJSON(rlt);
					if(rlt.status=="1"){
						$("[name='mobile_address_id']").val(index);
						//刷新
						if(rlt.data){
							address_change_init(rlt.data[index]);
						}
						if(rlt.str){
							$(".new-table.address").html(rlt.str);

						}
					}
				});
		});
	}
}
function get_address_from_weixin(){
	wx.ready(function() {
		wx.openAddress({
			success: function (res) {
				var data = {action: "add_web_address","index":-1,"set_default":1,"web_address_name":"微信地址"};
				jQuery.each(res,function(key,value){
					if(key=="userName"){
						data.shipping_first_name = value;
					}
					if(key=="telNumber"){
						data.shipping_phone = value;
					}
					if(key=="provinceName"){
						data.shipping_state_new = value;
					}
					if(key=="cityName"){
						data.shipping_city_new = value;
					}
					if(key=="countryName"){
						data.shipping_district_new = value;
					}
					if(key=="detailInfo"){
						data.shipping_address_1 = value;
					}
					if(key=="postalCode"){
						data.shipping_postcode = value;
					}

				});

				jQuery.post("/admin/admin-ajax.php", data, function (response) {
					location.reload();
				});
			},
			cancel: function (data) {

				console.log(data);
			}});
	});
}

function mobilecart_click(id){
	if( jQuery("#product-"+id+" form .single_add_to_cart_button").length>0 ){
		jQuery("#product-"+id+" form .single_add_to_cart_button").click();
	}else if(jQuery("#product-"+id+" .custom_btn_link .single_add_to_cart_button").length>0 ){
		jQuery("#product-"+id+" .custom_btn_link .single_add_to_cart_button").click();
	}
}
function mobilecart(){
	jQuery(".mobile_variation_warp").addClass("show");
	jQuery("#bottom-bar,#footer,#bitBanner,section.section,.right_nav_bar,#phantom").addClass("lowIndex");
	jQuery(".mobile_variation_warp").closest("section").removeClass("lowIndex").addClass("topIndex");
	jQuery(".mobile_variation_warp").closest(".bit_main_content").addClass("topIndex");
	jQuery(".mobile-mask").addClass("show");
	jQuery(".product_mobilecart").hide();
	jQuery('body').addClass("doing");
	var  height = jQuery(window).height();
	var isnotmove = false;
	if(jQuery("section.section.topIndex").length>0  && jQuery("section.section.topIndex").height()<height*0.75){
		isnotmove = true;
	}else{
		jQuery(".mobile_variation_warp").css("padding-bottom","0");
	}
	jQuery('html, body').on('touchmove', function(e){
		if(isnotmove){
			e.preventDefault();
		}
	});
	if(!isnotmove){
		jQuery("section.section.topIndex").nextAll("section.section").addClass("tmp_displaynone");
		jQuery("#bottom-bar,#footer").addClass("tmp_displaynone");
	}

}
function mobileunmask(){
	jQuery(".mobile-mask").removeClass("show");
	jQuery(".mobile_variation_warp").removeClass("show");
	jQuery(".mobile_variation_warp").closest("section").removeClass("topIndex");
	jQuery(".mobile_variation_warp").closest(".bit_main_content").removeClass("topIndex");
	jQuery("#bottom-bar,#footer,#bitBanner,section.section,.right_nav_bar,#phantom").removeClass("lowIndex");
	jQuery(".product_mobilecart").show();
	jQuery('body').removeClass("doing");
	jQuery("section.section,#bottom-bar,#footer").removeClass("tmp_displaynone");
}

function chang_city_init(){
	var $ = jQuery;
	// wc_country_select_params is required to continue, ensure the object exists
	if (typeof wc_country_select_params === "undefined")
		return false;

	/* State/Country select boxes */
	var states_json = wc_country_select_params.countries.replace(/&quot;/g, '"');
	var states = $.parseJSON( states_json );

	$('select.country_to_state, input.country_to_state').change(function(){
		var country = $(this).val();

		var $statebox = $(this).closest('div').find('#billing_state, #shipping_state, #calc_shipping_state');
		var $parent = $statebox.parent();

		var input_name = $statebox.attr('name');
		var input_id = $statebox.attr('id');
		var value = $statebox.val();
		var placeholder = $statebox.attr('placeholder');

		if (states[country]) {
			if (states[country].length == 0) {

				$statebox.parent().hide().find('.chosen-container').remove();
				$statebox.replaceWith('<input type="hidden" class="hidden" name="' + input_name + '" id="' + input_id + '" value="" placeholder="' + placeholder + '" />');

				$('body').trigger('country_to_state_changed', [country, $(this).closest('div')]);

			} else {

				var options = '';
				var state = states[country];
				for(var index in state) {
					options = options + '<option value="' + index + '">' + state[index] + '</option>';
				}
				$statebox.parent().show();
				if ($statebox.is('input')) {
					// Change for select
					$statebox.replaceWith('<select name="' + input_name + '" id="' + input_id + '" class="state_select" placeholder="' + placeholder + '"></select>');
					$statebox = $(this).closest('div').find('#billing_state, #shipping_state, #calc_shipping_state');
				}
				$statebox.html( '<option value="">' + wc_country_select_params.i18n_select_state_text + '</option>' + options);

				$statebox.val(value);

				$('body').trigger('country_to_state_changed', [country, $(this).closest('div')]);

			}
		} else {
			if ($statebox.is('select')) {

				$parent.show().find('.chosen-container').remove();
				$statebox.replaceWith('<input type="text" class="input-text" name="' + input_name + '" id="' + input_id + '" placeholder="' + placeholder + '" />');

				$('body').trigger('country_to_state_changed', [country, $(this).closest('div')]);

			} else if ($statebox.is('.hidden')) {

				$parent.show().find('.chosen-container').remove();
				$statebox.replaceWith('<input type="text" class="input-text" name="' + input_name + '" id="' + input_id + '" placeholder="' + placeholder + '" />');

				$('body').trigger('country_to_state_changed', [country, $(this).closest('div')]);

			}
		}

		$('body').trigger('country_to_state_changing', [country, $(this).closest('div')]);

	}).change();

}
function bit_product() {
	if (jQuery('.bitcommerce').length == 0)
		return false;
	// Tabs
	jQuery('.bitcommerce-tabs .panel').hide();

	jQuery('.bitcommerce-tabs ul.tabs li a').click(function () {

		var $tab = jQuery(this),
			$tabs_wrapper = $tab.closest('.bitcommerce-tabs');

		jQuery('ul.tabs li', $tabs_wrapper).removeClass('active');
		jQuery('div.panel', $tabs_wrapper).hide();
		jQuery('div' + $tab.attr('href'), $tabs_wrapper).show();
		$tab.parent().addClass('active');

		return false;
	});

	jQuery('.bitcommerce-tabs').each(function () {
		var hash = window.location.hash,
			url = window.location.href,
			tabs = jQuery(this);

		if (hash.toLowerCase().indexOf("comment-") >= 0) {
			jQuery('ul.tabs li.reviews_tab a', tabs).click();

		} else if (url.indexOf("comment-page-") > 0 || url.indexOf("cpage=") > 0) {
			jQuery('ul.tabs li.reviews_tab a', jQuery(this)).click();

		} else {
			jQuery('ul.tabs li:first a', tabs).click();
		}
	});

	jQuery('a.bitcommerce-review-link').click(function () {
		jQuery('.reviews_tab a').click();
		return true;
	});
	jQuery('#rating').hide();
	if (jQuery("p.stars").length == 0) {
		jQuery('#rating').before('<p class="stars"><span><a class="star-1" href="#">1</a><a class="star-2" href="#">2</a><a class="star-3" href="#">3</a><a class="star-4" href="#">4</a><a class="star-5" href="#">5</a></span></p>');
	}
	// Star ratings for comments


	jQuery('body')
		.on('click', '#respond p.stars a', function () {
			var $star = jQuery(this),
				$rating = jQuery(this).closest('#respond').find('#rating');

			$rating.val($star.text());
			$star.siblings('a').removeClass('active');
			$star.addClass('active');

			return false;
		})
		.on('click', '#respond #submit', function () {
			var $rating = jQuery(this).closest('#respond').find('#rating'),
				rating = $rating.val();

			if ($rating.size() > 0 && !rating && wc_single_product_params.review_rating_required === 'yes') {
				alert(wc_single_product_params.i18n_required_rating_text);

				return false;
			}
		});

	jQuery("div.quantity:not(.buttons_added), td.quantity:not(.buttons_added)").addClass('buttons_added').append('<input type="button" value="+" class="plus" />').prepend('<input type="button" value="-" class="minus" />').find(".input-text").attr("type", "text");

	// prevent double form submission
	jQuery('form.cart').submit(function () {
		jQuery(this).find(':submit').attr('disabled', 'disabled');
	});
	jQuery('.bitcommerce-main-image a').removeAttr("href").click(function () {
		jAlert("請在預覽下，查看圖片效果！");
	});
	jQuery('.button.add_to_cart_button,.button.product_type_simple').removeAttr("href").click(function () {
		jAlert("編輯情況下，無法使用購物車功能。如果修改商城默認頁面，你可以從左上角選擇功能頁面進行編輯！");

	});
	jQuery('.bitcommerce-ordering select.orderby').change(function () {
		jAlert("編輯情況下，無法使用排序功能！");
	})

	jQuery(".qfy_carousel .vc-carousel").each(function () {
		qfy_carousel_fun(jQuery(this))
	})
	if (jQuery(".addon-custom-datepicker").length > 0) {
		jQuery(".addon-custom-datepicker").datepicker({
			dateFormat: "yy-mm-dd",
			numberOfMonths: 1,
		});
	}
	if (jQuery(".addon-custom-datetimepicker").length > 0) {
		jQuery(".addon-custom-datetimepicker").datetimepicker({
			dateFormat: "yy-mm-dd",
			numberOfMonths: 1,
			showTime: true,
			constrainInput: false
		});
	}
}
function cart_button_warning(){
	jAlert("編輯情況下，無法使用購物車功能。如果修改商城默認頁面，你可以從左上角選擇功能頁面進行編輯");
}
function productplay(obj,event){
	//弹框显示

	var p = jQuery(obj).closest(".video-inner");
	if(p.length==1){
		var video =  p.find("video");
		jQuery(obj).hide();
		jQuery(obj).closest(".bitcommerce-main-image").find(".attachment-shop_single").hide();
		jQuery(obj).closest(".bitcommerce-main-image").find(".main-image").hide();
		video.show();
		video[0].play();
	}else{

		p = jQuery(obj).closest(".qfy_image_vc_item");
		if(p.closest(".thumbnails").length>0){
			return ;
		}else{
			var video =  p.find("video");
			jQuery(obj).hide();
			p.find(".ag_image").hide();
			video.show();
			video[0].play();
		}

	}
}
